<style>
.custom-box-top-bar {
    background: black;
    color: white;
    padding: 5px 10px;
    position: sticky;
    display: none;
    top: 0;
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    z-index: 1;
}
  .custom-box-top-bar.active{
    background: green !important;
    font-weight:400;
  }
  .custom-box-top-bar svg{
        border: 2px solid white;
    border-radius: 50%;
    height: 25px;
    width: 25px;
    padding: 4px !important;
    vertical-align: text-bottom;
    margin-right: 10px;
  }
.custom-box{
  padding: 80px 8px;
  text-align: center;
  padding-top: 20px;
}
.custom-box-btn-primary{
      display: inline-block;
    font-size: 12px;
    text-transform: uppercase;
    padding: 14px 28px;
    transition: all .45s cubic-bezier(.785,.135,.15,.86),border .45s cubic-bezier(.785,.135,.15,.86);
    background: black;
    color: white;
    border: 1px solid black;
    letter-spacing: 2px;
    margin-top: 12px;
  cursor: pointer;
}

.custom-box-drawer-footer  .custom-box-btn-primary{
background: green;
  }
.custom-box-btn-primary:hover{
  color: black;
  background: white;
}
.custom-box-size-guide-btn{
      margin-bottom: 80px;
}
.custom-box-wrapper{
  max-width: 1000px;
  width: 100%;
  margin: 0 auto;
}
.custom-box-heading{
      margin: 0;
    font-size: 45px;
    text-align: center;
    margin-bottom: 20px;
  font-weight: 700;
}
.custom-box-products-wrapper{
      display: flex;
  /* flex-direction:row-reverse; */
    flex-wrap: wrap;
    width: 100%;
}
.custom-box-products{
  width: 25%;
}
.custom-box-products-content{
      padding: 12px;
  text-align: center;
}
.custom-box-products-image-wrapper{
  
}
.custom-box-products-image{
  display: block;
    width: 100%;
    height: auto;
    max-width: 100%;
  cursor: pointer;
}
.custom-box-products-image-popup-overlay{
  display: none;
position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #00000061;
    z-index: 99999;
  padding: 20px;
}
.custom-box-products-image-popup-wrapper{
      display: block;
    width: 100%;
    max-width: 1000px;
    background: #f9f9f9;
    margin: 0 auto;
    height: 100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.5);
  border-radius: 4px;
  padding: 15px;
  position: relative;
}
.custom-box-products-image-popup-close{
      border: 3px solid white;
    border-radius: 50%;
    position: absolute;
    top: -18px;
    right: -18px;
    width: 36px;
    height: 36px;
    cursor: pointer;
    background: black;
    color: white;
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.custom-box-products-images{
    display: block;
    width: 100%;
    height: 100%;
    overflow-y: auto;
}
.custom-box-products-images img{
  display: block;
    width: 100%;
    height: auto;
    max-width: 100%;
}


.custom-box-size-popup-overlay{
    display: none;
position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #00000061;
    z-index: 99999;
  padding: 20px;
}
.custom-box-size-popup-wrapper{
        display: block;
    width: 100%;
    max-width: 1000px;
    background: #f9f9f9;
    margin: 0 auto;
    height: 100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.5);
  border-radius: 4px;
  padding: 15px;
  position: relative;
}
.custom-box-size-popup-close{
        border: 3px solid white;
    border-radius: 50%;
    position: absolute;
    top: -18px;
    right: -18px;
    width: 36px;
    height: 36px;
    cursor: pointer;
    background: black;
    color: white;
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.custom-box-size-popup-page{
      display: block;
    width: 100%;
    height: 100%;
    overflow-y: auto;
}
.custom-box-size-popup-page-title{
      font-weight: 700;
}
.custom-box-size-popup-page-content{
  
}

.custom-box-size-popup-page-content img{
  max-width: 100%;
  margin: 0 auto;
  display: block;
}

  
.custom-box-products-title{
      margin: 0;
    margin-top: 10px;
  font-size: 15px;
  text-align: center;
}
.custom-box-products-variants{
      display: block;
    width: 100%;
    max-width: 160px;
    margin: 0 auto;
    padding: 3px;
    margin-top: 10px;
  box-shadow: none !important;
  outline: 0 !important;
}
.custom-box-atc-btn{
  position: relative;
}
.custom-box-atc-btn.active::after{
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: black;
  z-index: 2;
}
.custom-box-atc-btn.active::before{
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  border: 2px solid white;
  border-radius: 50%;
  background: black;
  border-left-color: transparent;
  z-index: 3;
  animation: animateAtc 0.5s linear infinite;
}
@keyframes animateAtc{
  0%{transform: translate(-50%, -50%) rotate(0deg)}
  100%{transform: translate(-50%, -50%) rotate(360deg)}
}
.custom-box-atc-btn.active{
  pointer-events: none;
}
.custom-box-atc-btn.box-full{
  pointer-events: none !important;
}
.custom-box-atc-btn.box-full::after{
  content: 'Box Full';
  background: black;
  text-align: center;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  color: white;
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
}
.custom-box-atc-btn span{
  display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    z-index: 1;
    padding: 14px 28px;
}

.custom-box-drawer-overlay{
      position: fixed;
    right: 0;
    top: 0;
    width: 100%;
    height: 100dvh;
    background: #00000059;
    z-index: 999999;
  display: none;
}
.custom-box-drawer-wrapper{
      width: 100%;
    max-width: 500px;
    background: white;
    height: 100%;
    margin-left: auto;
}
.custom-box-drawer{
      width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}
.custom-box-drawer-header{
    margin: 0;
    display: flex;
    justify-content: space-between;
    padding: 26px 16px;
    font-size: 20px;
    font-weight: 600;
  color: black;
  order: 1;
}
.custom-box-drawer-close{
      display: block;
    padding: 0 10px;
    cursor: pointer;
}
.custom-box-drawer-content{
  padding: 16px;
    background: #f3f3f2;
    flex: 1 1 auto;
  overflow-y: auto;
  order: 3;
}
.custom-box-drawer-totals{
      margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: black;
}
  .custom-box-drawer-totals em{
          margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: black;
    font-style: normal;
  }
.custom-box-drawer-content-products{
  
}
.custom-box-drawer-product-wrapper{
      display: flex;
    flex-wrap: wrap;
    width: 100%;
    border-bottom: 1px solid #e7e7e5;
    align-items: center;
    padding: 16px 0;
}
.custom-box-drawer-product-wrapper:last-child{
  border-bottom: 0;
}
.custom-box-drawer-product-image{
      flex: 0 0 calc(100% - 80px);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
}
.custom-box-drawer-product-img{
  display: block;
    width: 100%;
    height: auto;
    max-width: 80px;
    margin-right: 16px;
}
.custom-box-drawer-product-title{
      flex: 0 0 calc(100% - 96px);
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: black;
}
.custom-box-drawer-product-tool{
      flex: 0 0 80px;
    text-align: right;
    display: flex;
    justify-content: flex-end;
    align-items: center;
}
.custom-box-drawer-product-qty{
      margin-right: 16px;
    font-size: 18px;
    font-weight: 600;
    color: black;
}
.custom-box-drawer-product-remove{
  cursor: pointer;
}
.custom-box-drawer-product-remove svg{
  display: block;
}
.custom-box-drawer-open {
    text-decoration: underline;
    margin-left: 10px;
    cursor: pointer;
}
.custom-box-drawer-footer{
  padding: 16px;
  order: 5;
}
.custom-box-atc{
      margin: 0;
  position: relative;
}
  .custom-box-atc.active{
    pointer-events: none;
  }
  .custom-box-atc::before{
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: black;
    height: 100%;
    z-index: 1;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    transition: all 0.25s ease-in-out;
  }
  .custom-box-atc::after{
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 3px solid white;
    height: 20px;
    width: 20px;
    z-index: 2;
    border-radius: 50%;
    border-left-color: transparent;
    animation: animateQuizButton 0.5s linear infinite;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    transition: all 0.25s ease-in-out;
  }
  .custom-box-atc.active::before,
  .custom-box-atc.active::after{
    visibility: visible;
    opacity: 1;
  }
  @keyframes animateQuizButton {
    0% { 
        transform: translate(-50%, -50%) rotate(0deg);
    }
    100% { 
        transform: translate(-50%, -50%) rotate(360deg);
    }
  }
  @media screen and (max-width: 1100px){
    .custom-box-products{
      width: 33.33%;
    }
  }
  @media screen and (max-width: 992px){
    .custom-box-heading{
      font-size: 30px;
    }
  }
  @media screen and (max-width: 650px){
   
.custom-box-drawer-open {
    margin-left: 4px;
  }
.custom-box-top-bar svg {
    height: 20px;
    width: 20px;
   margin-right: 2px;
}
    .custom-box-top-bar {
      font-size:14px;
    }
    .custom-box-products{
      width: 50%;
    }
    .custom-box-drawer-footer{
    order: 2;
    padding-top: 0;
    }
    .custom-box-atc{
      display: block;
      width: 100%;
    }
  }
  @media screen and (max-width: 391px){
  .custom-iwt3.active {
    margin-top: 20px;
}
  }
  @media screen and (max-width: 320px){
  .custom-iwt3.active {
    margin-top: 30px;
}
  }
    
  .custom-box-drawer-footer-note{
    display: none;
        margin: 0;
    margin-bottom: 15px;
    line-height: 1.3;
    font-size: 14px;
  }
  .custom-bx-swiper::part(button-prev) {
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: black;
    top: 32%;
    left: 15px;
  }
  .custom-bx-swiper::part(button-prev)::after{
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    background: white;
    border: 1px solid #00000063;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    z-index: -1;
    transform: translate(-50%, -50%);
  }
  .custom-bx-swiper::part(button-next) {
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: black;
    top: 32%;
    right: 15px;
  }
  .custom-bx-swiper::part(button-next)::after{
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    background: white;
    border: 1px solid #00000063;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    z-index: -1;
    transform: translate(-50%, -50%);
  }
  @media screen and (min-width: 769px){
    .site-header{
      padding-bottom: 0;
    }
  }
</style>
{% if section.settings.main_product != blank %}
<div class="custom-box-top-bar"><svg height="14" role="img" viewBox="0 0 20 20" width="14" xmlns="http://www.w3.org/2000/svg" style="padding-top: 2px;"> <path d="M7.3 13.523 18.027 0.216 19.973 1.784 7.484 17.277 0.108 9.77 1.892 8.018" fill="currentColor"></path> </svg> 
{{ section.settings.selected_text | replace: '(selected)', '<span class="custom-box-selected"></span>' | replace: '(t', '<span class="custom-limit-max">' | replace: 'ota', section.settings.limit | replace: 'l)', '</span>' }} <span class="custom-box-drawer-open">View</span></div>
<div class="custom-box" id="custom-box">
  {% if section.settings.size_guide_btn_text != blank and section.settings.size_guide_page != blank %}
    <button type="button" class="custom-box-btn-primary custom-box-size-guide-btn">{{ section.settings.size_guide_btn_text }}</button>
  {% endif %}
  <div class="custom-box-wrapper">
    {% if section.settings.heading != blank %}
      <h2 class="custom-box-heading">{{ section.settings.heading }}</h2>
    {% endif %}
    {% if section.settings.show and section.settings.coll != blank %}
      <div class="custom-box-products-wrapper">
        {% paginate collections[section.settings.coll].products by 5000 %}
          {% for product in collections[section.settings.coll].products %}
            <div class="custom-box-products">
              <div class="custom-box-products-content">
                {% if product.images.size > 0 %}
                  <div class="custom-box-products-image-wrapper">
                    {% if product.featured_image %}
                      <img src="{{ product.featured_image | img_url: '400x' }}" class="custom-box-products-image" />
                    {% endif %}
                    <div class="custom-box-products-image-popup-overlay">
                      <div class="custom-box-products-image-popup-wrapper">
                        <span class="custom-box-products-image-popup-close">&#10005;</span>
                        <div class="custom-box-products-images">
                          {% for image in product.images %}
                            <img src="{{ image | img_url: '1920x' }}" />
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}
                <p class="custom-box-products-title">{{ product.title }}</p>
                <select class="custom-box-products-variants" {% if product.has_only_default_variant %}hidden{% endif %}>
                  {% for variant in product.variants %}
                    <option value="{{ product.title }} - {{ variant.title }}" data-vid="{{ variant.id }}" {% if product.selected_or_first_available_variant == variant %}selected{% endif %}>{{- variant.title -}}</option>
                  {% endfor %}
                </select>
                <button type="button" class="custom-box-btn-primary custom-box-atc-btn"><span>ADDED</span> {{ section.settings.atc_btn_text }}</button>
              </div>
            </div>
          {% endfor %}
        {% endpaginate %}
      </div>
    {% endif %}
  </div>
</div>

<div class="custom-box-drawer-overlay">
  <div class="custom-box-drawer-wrapper">
    <div class="custom-box-drawer">
      <h2 class="custom-box-drawer-header">
        <p class="custom-box-drawer-totals"><em>Your box</em> Items (<span class="custom-box-selected"></span>/<span class="custom-limit-max">{{ section.settings.limit }}</span>)</p>
        <span class="custom-box-drawer-close">&#10005;</span></h2>
      <div class="custom-box-drawer-content">
        
        <div class="custom-box-drawer-content-products"></div>
  {% assign coll = collections[settings.mcoll].products %}
  {% if coll.size > 0 %}
        <div class="custom-rec-wrapper">
          {% if settings.coll_title != blank %}
            <div class="custom-rec-heading">
            {{ settings.coll_title }}
                    {% assign mainPro = all_products[section.settings.main_product] %}
        {% if mainPro.metafields.custom.mystery_box_next_product != blank %}
          {% assign metaPd = all_products[mainPro.metafields.custom.mystery_box_next_product] %}
          <p class="custom-box-drawer-footer-note">{{ section.settings.note }}</p>
        {% endif %}
            </div>
          {% endif %}
          <swiper-container slides-per-view="2" space-between="15" navigation="true" slides-per-group="2" class="custom-bx-swiper">

              {% for pd in coll %}
                <swiper-slide>
                  <div class="custom-rec-form">
                    <img src="{{ pd.featured_image | img_url: '400x' }}" class="custom-rec-img" />
                    <p class="custom-rec-title">{{ pd.title }}</p>
                    <p class="custom-rec-price" style="display:none;">{{ pd.price | money }}</p>
                    <input type="hidden" name="quantity" value="1" />
                      <select name="id" class="custom-rec-variants">
                        {% for variant in pd.variants %}
                          <option value="{{ pd.title }} - {{ variant.title }}" data-vid="{{ variant.id }}" {% if pd.selected_or_first_available_variant == variant %}selected{% endif %}>{{ variant.title }}</option>
                        {% endfor %}
                      </select>
                    <button type="button" class="custom-rec-btn-2"><span>ADDED</span> ADD TO BOX</button>
                  </div>
                </swiper-slide>
              {% endfor %}
            
          </swiper-container>
        </div>
{% endif %}
      </div>
      <div class="custom-box-drawer-footer">
        <button type="button" class="custom-box-btn-primary custom-box-atc">Add to cart</button>
      </div>
    </div>
  </div>
</div>


  <div class="custom-box-size-popup-overlay">
    <div class="custom-box-size-popup-wrapper">
      <span class="custom-box-size-popup-close">&#10005;</span>
      {% assign page = pages[section.settings.size_guide_page] %}
      <div class="custom-box-size-popup-page">
        <h2 class="custom-box-size-popup-page-title">{{ page.title }}</h2>
        <div class="custom-box-size-popup-page-content">
          {{ page.content }}
        </div>
      </div>
    </div>
  </div>

<script>
  $(".custom-box-products-image").click(function(){
    $(this).parent().find(".custom-box-products-image-popup-overlay").fadeIn(300);
  });
  $(".custom-box-products-image-popup-close").click(function(){
    $(this).parents(".custom-box-products-image-popup-overlay").fadeOut(300);
  });
  $(".custom-box-products-image-popup-wrapper").click(function(e){
    e.stopPropagation();
  });
  $(".custom-box-products-image-popup-overlay").click(function(){
    $(this).fadeOut(300);
  });

  $(".custom-box-drawer-close").click(function(){
    $(".custom-box-drawer-overlay").fadeOut(300);
    $("body").removeClass("overflow-hidden");
  });
  $(".custom-box-drawer-open").click(function(){
    $(".custom-box-drawer-overlay").fadeIn(300);
    $("body").addClass("overflow-hidden");
  });
  $(".custom-box-drawer-wrapper").click(function(e){
    e.stopPropagation();
  });
  $(".custom-box-drawer-overlay").click(function(){
    $(this).fadeOut(300);
    $("body").removeClass("overflow-hidden");
  });

  $(".custom-box-atc-btn, .custom-rec-btn-2").click(function(){
    let $this = $(this);
    $this.addClass("active");
    setTimeout(function(){
      $this.find("span").show();
    }, 600);
    setTimeout(function(){
      $this.removeClass("active");
    }, 700);
    setTimeout(function(){
      $this.find("span").fadeOut(300);
    }, 1500);
    let parent = $(this).parent();
    let limit = parseInt('{{- section.settings.limit -}}');
    let limit2 = -1;
    {% assign limit2 = all_products[section.settings.main_product].metafields.custom.mystery_box_next_product_limit %}
    {% if limit2 != blank and limit2 > 0 %}
      limit2 = parseInt('{{- limit2 -}}');
    {% endif %}
    let productTitle = $this.hasClass("custom-rec-btn-2") ? parent.find(".custom-rec-variants option:selected").val() : parent.find(".custom-box-products-variants option:selected").val();
    let variantId = $this.hasClass("custom-rec-btn-2") ? parent.find(".custom-rec-variants option:selected").attr("data-vid") : parent.find(".custom-box-products-variants option:selected").attr("data-vid");
    let image = $this.hasClass("custom-rec-btn-2") ? parent.find(".custom-rec-img").attr("src") : parent.find(".custom-box-products-image").attr("src");
    
    let box = localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}");
    let boxArr = [];
    if(box != null && box != undefined){
      boxArr = JSON.parse(box);
      boxArr.push({id: variantId, quantity: 1, title: productTitle, image: image});
      let boxArrString = JSON.stringify(boxArr);
      localStorage.setItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}", boxArrString);
    }
    else{
      boxArr.push({id: variantId, quantity: 1, title: productTitle, image: image});
      let boxArrString = JSON.stringify(boxArr);
      localStorage.setItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}", boxArrString);
    }
    updateBoxDrawer();
    let updatedBox = JSON.parse(localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}"));
    if(limit2 <= 0){
      if(updatedBox.length >= limit){
        $(".custom-box-drawer-overlay").fadeIn(300);
        $("body").addClass("overflow-hidden");
      }
    }
    else{
      if(updatedBox.length == limit || updatedBox.length >= limit2){
        $(".custom-box-drawer-overlay").fadeIn(300);
        $("body").addClass("overflow-hidden");
      }
      if(updatedBox.length > limit){
        $(".custom-limit-max").text(limit2);
      }
      else{
        $(".custom-limit-max").text(limit);
      }
    }
  });

  $(function(){
    let d = $(".custom-box-top-bar").detach();
    $("#SiteHeader").append(d);
    updateBoxDrawer();
  });

  function updateBoxDrawer(){
    let limit = parseInt('{{- section.settings.limit -}}');
    let limit2 = -1;
    {% assign limit2 = all_products[section.settings.main_product].metafields.custom.mystery_box_next_product_limit %}
    {% if limit2 != blank and limit2 > 0 %}
      limit2 = parseInt('{{- limit2 -}}');
    {% endif %}
    let updatedBox = JSON.parse(localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}"));
    $(".custom-box-drawer-content-products").empty();
    if(updatedBox.length > 0){
      $(".custom-box-top-bar").show();
      $(".custom-box-selected").text(updatedBox.length);
      for(item of updatedBox){
        let data = `<div class="custom-box-drawer-product-wrapper">
          <div class="custom-box-drawer-product-image">
            <img src="${item.image}" class="custom-box-drawer-product-img" />
            <p class="custom-box-drawer-product-title">${item.title}</p>
          </div>
          <div class="custom-box-drawer-product-tool">
            <span class="custom-box-drawer-product-qty">x${item.quantity}</span> <span class="custom-box-drawer-product-remove" data-line="${item.id}"><svg height="24" role="img" viewBox="0 0 20 24" width="24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.71664471,7.81271542 L4.71664471,22.3187412 L15.9207134,22.3187412 L15.9207134,7.81271542 L17.6897769,7.81271542 L17.6897769,24.0878049 L2.94758123,24.0878049 L2.94758123,7.81271542 L4.71664471,7.81271542 Z M8.8444595,7.81271542 L8.8444595,19.680183 L7.07539601,19.680183 L7.07539601,7.81271542 L8.8444595,7.81271542 Z M13.5619621,7.81271542 L13.5619621,19.680183 L11.7928987,19.680183 L11.7928987,7.81271542 L13.5619621,7.81271542 Z M14.2401032,0.087804878 L14.2401032,3.21256068 L20.5205733,3.21256068 L20.5205733,4.98162416 L0.116489966,4.98162416 L0.116195122,3.21256068 L6.39666533,3.21256068 L6.39666533,0.087804878 L14.2401032,0.087804878 Z M12.4713345,1.85686836 L8.16602366,1.85686836 L8.16602366,3.21247222 L12.4713345,3.21362212 L12.4713345,1.85686836 Z" fill="currentColor"></path>
              </svg></span>
          </div>
        </div>`;
        $(".custom-box-drawer-content-products").append(data);
      }
    }
    else{
      $(".custom-box-top-bar").hide();
      $(".custom-box-drawer-overlay").fadeOut(300);
      $("body").removeClass("overflow-hidden");
      $(".custom-box-selected").text("");
    }
    if(limit2 <= 0){
      if(updatedBox.length >= limit){
        $(".custom-box-atc-btn, .custom-rec-btn-2").addClass("box-full");
        $(".custom-box-drawer-footer").show();
        $(".custom-box-top-bar").addClass("active");
        $(".custom-iwt3").addClass("active");
      }
      else{
        $(".custom-box-atc-btn, .custom-rec-btn-2").removeClass("box-full");
        $(".custom-box-drawer-footer").hide();
        $(".custom-box-top-bar").removeClass("active");
          $(".custom-iwt3").removeClass("active");
      }
    }
    else{
      if(updatedBox.length == limit || updatedBox.length >= limit2){
        $(".custom-box-drawer-footer").show();
        $(".custom-box-drawer-footer-note").show();
        $(".custom-box-top-bar").addClass("active");
         $(".custom-iwt3").addClass("active");
      }
      else{
        $(".custom-box-atc-btn, .custom-rec-btn-2").removeClass("box-full");
        $(".custom-box-drawer-footer").hide();
        $(".custom-box-drawer-footer-note").hide();
        $(".custom-box-top-bar").removeClass("active");
         $(".custom-iwt3").removeClass("active");
      }
      if(updatedBox.length == limit){
        $(".custom-box-drawer-footer-note").show();
      }
      if(updatedBox.length >= limit2){
        $(".custom-box-atc-btn, .custom-rec-btn-2").addClass("box-full");
        $(".custom-box-drawer-footer-note").hide();
      }
      if(updatedBox.length > limit){
        $(".custom-limit-max").text(limit2);
      }
      else{
        $(".custom-limit-max").text(limit);
      }
    }
    $(".custom-box-drawer-content-products .custom-box-drawer-product-remove").click(function(){
      console.log("test");
      let line = parseInt($(this).attr("data-line"));
      let box = localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}");
      let boxArr = JSON.parse(box);
      let idx = boxArr.findIndex(p => p.id==line);
      if(idx >= 0){
        boxArr.splice(idx, 1);
      }
      let boxArrString = JSON.stringify(boxArr);
      localStorage.setItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}", boxArrString);
      updateBoxDrawer();
    });
  }

  $(".custom-box-atc").click(function(){
    let variantId = '{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}';
    let limit = parseInt('{{- section.settings.limit -}}');
    let limit2 = -1;
    {% assign limit2 = all_products[section.settings.main_product].metafields.custom.mystery_box_next_product_limit %}
    {% if limit2 != blank and limit2 > 0 %}
      limit2 = parseInt('{{- limit2 -}}');
    {% endif %}
    let updatedBox = JSON.parse(localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}"));
    if(limit2 != -1){
      if(updatedBox.length >= limit2){
        {% assign mainPro = all_products[section.settings.main_product] %}
        {% if mainPro.metafields.custom.mystery_box_next_product != blank %}
          variantId = '{{- all_products[mainPro.metafields.custom.mystery_box_next_product].selected_or_first_available_variant.id -}}';
        {% endif %}
      }
    }
    let box = localStorage.getItem("mystery-box-{{- all_products[section.settings.main_product].selected_or_first_available_variant.id -}}");
    let boxArr = JSON.parse(box);
    let arr = [];
    let prop = {};
    for(let i=0; i<boxArr.length; i++){
      prop[`Jewellery ${i+1}`] = boxArr[i].title;
    }
    arr.push({'id': variantId, 'quantity': 1, properties: prop});
    ATCtoCart(arr, $(this));
  });

    function ATCtoCart(productsArr, $this){
        $this.addClass("active");
        let formData = {
            'items': productsArr
        };
        fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'xmlhttprequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            return response.json();
        })
        .then(res => {
            $this.removeClass("active");
            location.href = "/cart";
        })
        .catch((error) => {
            console.error('Error:', error);
            $this.removeClass("active");
        })
        .finally(() => {
            $this.removeClass("active");
        });
    }

  $(".custom-box-size-guide-btn").click(function(){
    $(".custom-box-size-popup-overlay").fadeIn(300);
  })

  $(".custom-box-size-popup-close").click(function(){
    $(this).parents(".custom-box-size-popup-overlay").fadeOut(300);
  });
  $(".custom-box-size-popup-wrapper").click(function(e){
    e.stopPropagation();
  });
  $(".custom-box-size-popup-overlay").click(function(){
    $(this).fadeOut(300);
  });

</script>
{% endif %}
{% schema %}
  {
    "name": "Custom Mystery Box",
    "settings": [
      {
        "type": "product",
        "id": "main_product",
        "label": "Main Product"
      },
      {
        "type": "text",
        "id": "selected_text",
        "label": "Box Top Bar Text",
        "default": "Yay! You've selected (selected) out of your (total) jewellery."
      },
      {
        "type": "text",
        "id": "size_guide_btn_text",
        "label": "Size Guide Button Text",
        "default": "Size guide"
      },
      {
        "type": "page",
        "id": "size_guide_page",
        "label": "Size Guide Page"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "CHOOSE YOUR 7 PIECES OF JEWELLERY"
      },
      {
        "type": "number",
        "id": "limit",
        "label": "Box Limit",
        "default": 7
      },
      {
        "type": "checkbox",
        "id": "show",
        "label": "Show Products",
        "default": true
      },
      {
        "type": "collection",
        "id": "coll",
        "label": "Select Collection"
      },
      {
        "type": "text",
        "id": "atc_btn_text",
        "label": "Add to Box Button Text",
        "default": "Add to box"
      },
      {
        "type": "text",
        "id": "note",
        "label": "Add more note",
        "default": "Add 2 more to get"
      }
    ]
  }
{% endschema %}