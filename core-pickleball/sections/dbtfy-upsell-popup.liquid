{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}
{%- if section.blocks.size > 0 -%}
<div class="dbtfy dbtfy-upsell_popup" data-section-id="{{ section.id }}" data-section-type="upsell-popup">

  <!-- Blocks -->
  {% for block in section.blocks %}
    {%- assign not_in_cart = true -%}
    {%- assign in_stock = false -%}
    {%- assign valid_upsell = false -%}
    {%- assign trigger_empty = false -%}

    {% if block.settings.dbtfy_upsell_popup_product_trigger != empty %}
      {%- assign product_trigger = all_products[block.settings.dbtfy_upsell_popup_product_trigger] -%}
  	{% else %}
      {% assign trigger_empty = true %}
  	{% endif %}

  	{% if block.settings.dbtfy_upsell_popup_product_offer != empty %}
      {%- assign product_offer = all_products[block.settings.dbtfy_upsell_popup_product_offer] -%}
    {% endif %}

    {%- assign loop = 0 -%}

    {% for item in cart.items %}
      {% if item.product.handle == product_offer.handle %}
        {% assign not_in_cart = false %}
        {% break %}
      {% endif %}
    {% endfor %}

  	{% if product_offer.available %}
      {% assign in_stock = true %}
	{% endif %}

    {% if not_in_cart and in_stock %}
      {% assign valid_upsell = true %}
    {% endif %}

    {% if valid_upsell %}
      <div data-offer="{{product_offer.id}}" id="UpsellPopup-{{product_trigger.id}}"
           class="modal-upsell_popup {% if trigger_empty %}empty-upsell_popup{% endif %}" {{ block.shopify_attributes }}>
        <div class="modal-dialog-upsell_popup" style="max-width:{{ section.settings.dbtfy_upsell_popup_width }}px">
          <div class="modal-content modal-content-upsell_popup animated {{ section.settings.dbtfy_upsell_popup_animation }}">

            <div class="progress">
              <div data-progress="{{section.settings.dbtfy_upsell_popup_range }}%" style="width:20%;" class="progress-bar progress-bar-striped progress-bar-animated"></div>
            </div>

            <div class="header-upsell_popup">
              <h4 class="offer-title-upsell_popup">{{ product_offer.title}}</h4>
              <button type="button" class="btn btn-square-small icon-fallback-text close-upsell_popup">
                <span class="fas fa-times" aria-hidden="true"></span>
                <span class="fallback-text">Close Upsell</span>
              </button>
            </div>

            <div class="body-upsell_popup wrapper-fluid">
              <div class="grid grid-uniform grid-upsell_popup">

                <div class="grid__item small--two-thirds one-half product-upsell_popup">
                  <div class="grid-product__image-wrapper">
                    <div class="image-wrapper">

                      {% for variant in product_offer.variants %}
                        {%- assign loop = loop | plus: 1 -%}
                        {% if variant.available %}
                          {% if variant.image %}
                            {%- assign image = variant.image -%}
                          {% else %}
                            {%- assign image = product_offer.featured_image -%}
                          {% endif %}

                          {%- assign img_url = image | img_url: "1x1" | replace: "_1x1.", "_{width}x." -%}
                          <div class="image-upsell_popup image-upsell_popup-{{ variant.id }}" style="{% unless loop == 1 %}display:none;{% endunless %} padding-top:{{ 1 | divided_by: image.aspect_ratio | times: 100 }}%;">
                            <img class="image lazyload"
                                 src="{{ image | img_url: "small" }}"
                                 data-src="{{ img_url }}"
                                 data-widths="[180, 370, 590, 740, 900, 1080, 1296, 1512, 1728, 2048]"
                                 data-aspectratio="{{ image.aspect_ratio }}"
                                 data-sizes="auto"
                                 alt="{{ image.alt | escape }}"
                                 data-image>
                          </div>
                        {% else %}
                          {%- assign loop = loop | minus: 1 -%}
                        {% endif %}
                      {% endfor %}

                    </div>
                  </div>
                </div>

                <div class="grid__item medium--one-half large--one-half content-upsell_popup {{ section.settings.text_alignment }}">
                  <div class="text-container-upsell_popup rte">
                    {% if block.settings.dbtfy_upsell_popup_title != empty %}
                    <h3 class="title-upsell_popup">{{ block.settings.dbtfy_upsell_popup_title }}</h3>
                    {% endif %}

                    {% if block.settings.dbtfy_upsell_popup_text != empty %}
                    {{ block.settings.dbtfy_upsell_popup_text }}
                    {% endif %}
                  </div>

                  <form autocomplete="off" action="/cart/add" method="post" class="form-upsell_popup" enctype="multipart/form-data">
                    <select class="select-upsell-popup select--small full {% if product_offer.variants.size <= 1 %}hide{% endif %}" name="id">
                      {% for variant in product_offer.variants %}
                        {% if variant.available %}
                          <option {% if variant == product_offer.selected_or_first_available_variant %}selected="selected"{% endif %} value="{{ variant.id }}">{{ variant.title | escape }} - {{ variant.price | money }}</option>
                        {% else %}
                          <option disabled="disabled">{{ variant.title | escape }} - {{ "products.product.sold_out" | t }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>

                    {% if block.settings.button_label != empty %}
                    <button type="button"
                            {% if block.settings.dbtfy_upsell_popup_coupon != empty%}
                              {% if block.settings.dbtfy_upsell_popup_redirect %}
                              data-href="/discount/{{ block.settings.dbtfy_upsell_popup_coupon }}?redirect=/cart"
                              {% else %}
                              data-href="/checkout/?discount={{ block.settings.dbtfy_upsell_popup_coupon }}"
                              {% endif %}
                            {% else %}
                              {% if block.settings.dbtfy_upsell_popup_redirect %}
                              data-href="/cart"
                              {% else %}
                              data-href="/checkout"
                              {% endif %}
                            {% endif %}
                            class="btn btn--buy btn--full btn--upsell_popup">
                      <span class="btn__text">
                        {% if block.settings.dbtfy_upsell_popup_icon != empty %}
                        <span class="fas fa-{{ block.settings.dbtfy_upsell_popup_icon }}"></span>
                        {% endif %}
                        {{ block.settings.button_label | escape }}
                      </span>
                    </button>
                    {% endif %}
                  </form>
                  {% unless product_offer.description == blank or section.settings.dbtfy_upsell_popup_description == empty %}
                    <button class="toggle-description-upsell_popup text-link" type="button">{{ section.settings.dbtfy_upsell_popup_description }}</button>
                  {% endunless %}
                </div>
              </div>
            </div>

            {% unless product_offer.description == blank or section.settings.dbtfy_upsell_popup_description == empty %}
              <div class="description-upsell_popup rte animated fadeIn hide">
                {{ product_offer.description }}
              </div>
            {% endunless %}

            <div class="footer-upsell_popup grid--full">
              <div class="grid__item one-half">
                {% if block.settings.dbtfy_upsell_popup_cart != empty %}
                <button type="button" class="cart-upsell_popup">
                  <small class="btn__text">{{ section.settings.dbtfy_upsell_popup_cart }}</small>
                </button>
                {% endif %}
              </div>
              <div class="grid__item one-half text-right">
                {% if block.settings.dbtfy_upsell_popup_chekout != empty %}
                <button class="checkout-upsell_popup">
                  <small class="btn__text">{{ section.settings.dbtfy_upsell_popup_checkout }}</small>
                </button>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="overlay-upsell_popup"></div>
    {% endif %}

  {% endfor %}

</div>
{%- endif -%}
{% schema %}
  {
    "name": "Upsell pop-up",
    "settings": [
      {
        "type": "text",
        "id": "dbtfy_upsell_popup_width",
        "label": "Width",
        "default": "600"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_popup_description",
        "label": "Description text",
        "default": "See product details"
      },
	  {
        "type": "text",
        "id": "dbtfy_upsell_popup_cart",
        "label": "Decline offer text",
        "default": "No thanks"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_popup_checkout",
        "label": "Checkout text",
        "default": "Go to checkoutâ†’"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_popup_animation",
        "label": "Animation type",
        "default": "bounceIn",
        "info": "Enter the name of any animation from [animate.css](https:\/\/daneden.github.io\/animate.css\/)"
      },
      {
        "type": "select",
        "id": "text_alignment",
        "label": "Text alignment",
        "default": "text-center",
        "options": [
          {
            "value": "",
            "label": "Left"
          },
          {
            "value": "text-center",
            "label": "Center"
          }
        ]
      },
      {
        "type": "range",
        "id": "dbtfy_upsell_popup_range",
        "label": "Progress bar width",
        "min": 50,
        "max": 90,
        "step": 1,
        "unit": "%",
        "default": 75
      }
    ],
    "blocks" : [
      {
        "type": "upsell",
        "name": "Upsell",
        "settings": [
          {
            "type": "checkbox",
            "id": "dbtfy_upsell_popup_redirect",
            "label": "Redirect to cart",
			"info": "Default redirects to checkout"
          },
          {
            "type": "text",
            "id": "dbtfy_upsell_popup_title",
            "label": "Title",
            "default": "Get 20% OFF!"
          },
          {
            "type": "richtext",
            "id": "dbtfy_upsell_popup_text",
            "label": "Text",
            "default": "<p>Add this product to your cart and get 20% OFF your entire order.<\/p>"
          },
          {
            "type": "product",
            "id": "dbtfy_upsell_popup_product_trigger",
            "label": "Product trigger",
			"info": "Leave empty to trigger on all products"
          },
          {
            "type": "product",
            "id": "dbtfy_upsell_popup_product_offer",
            "label": "Product offer"
          },
          {
            "type": "text",
            "id": "button_label",
            "label": "Button label",
			"default": "Claim offer!"
          },
		  {
            "type": "text",
            "id": "dbtfy_upsell_popup_icon",
            "label": "Button icon",
			"info": "Enter the name of any free solid icons on [FontAwesome](https://fontawesome.com/icons?d=gallery&s=solid&m=free)",
			"default": "gift"
          },
		  {
            "type": "text",
            "id": "dbtfy_upsell_popup_coupon",
            "label": "Coupon code",
            "info": "This coupon code will automatically be applied at checkout"
          }
        ]
      }
    ]
  }
{% endschema %}