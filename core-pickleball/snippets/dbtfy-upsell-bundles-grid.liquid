{% assign on_sale = false %}
{% if product.compare_at_price > product.price %}
  {% assign on_sale = true %}
{% endif %}

{% assign sold_out = true %}
{% if product.available %}
  {% assign sold_out = false %}
{% endif %}

{%- assign variant = product.selected_or_first_available_variant -%}
{%- assign product_link = product.url | within: collection -%}

{% unless sold_out %}

{% if type == "image" %}
<div class="grid__item {{ grid_item_width }} image-item-upsell_bundles selected-image-upsell_bundles grid-image-{{ product.id }} {% if item == "first" %}current-image-upsell_bundles{% endif %}">

  {%- assign loop = 0 -%}

  {% unless product.has_only_default_variant %}
    {% for variant in product.variants %}
      {% if variant.available %}
        {%- assign loop = loop | plus: 1 -%}
        {% if variant.image %}
          {%- assign image = variant.image -%}
        {% else %}
          {%- assign image = product.featured_image -%}
        {% endif %}
        {%- assign img_url = image | img_url: "1x1" | replace: "_1x1.", "_{width}x." -%}
  		<a id="imageUpsellBundles-{{ variant.id }}" class="loop-{{loop}} grid-product__image-link image-link image-link-upsell_bundles" {% unless item == "first" %}href="{{ product_link }}"{% endunless %}  style="{% unless loop == 1 %}display:none;{% endunless %}">
          <div class="product--wrapper image-wrapper">
            <div style="padding-top:{{ 1 | divided_by: image.aspect_ratio | times: 100 }}%;">
              <img class="product--image image lazyload"
                   src="{{ image | img_url: "small" }}"
                   data-src="{{ img_url }}"
                   data-widths="[180, 370, 590, 740, 900, 1080, 1296, 1512, 1728, 2048]"
                   data-aspectratio="{{ image.aspect_ratio }}"
                   data-sizes="auto"
                   alt="{{ image.alt | escape }}"
                   data-image>
            </div>
          </div>
        </a>
      {% endif %}
    {% endfor %}
  {% else %}
    {%- assign loop = 1 -%}
    {%- assign image = product.featured_image -%}
    {%- assign img_url = image | img_url: "1x1" | replace: "_1x1.", "_{width}x." -%}
    <a id="imageUpsellBundles-{{ variant.id }}" class="loop-{{loop}} grid-product__image-link image-link image-link-upsell_bundles" {% unless item == "first" %}href="{{ product_link }}"{% endunless %}  style="{% unless loop == 1 %}display:none;{% endunless %}">
      <div class="product--wrapper image-wrapper">
        <div style="padding-top:{{ 1 | divided_by: image.aspect_ratio | times: 100 }}%;">
          <img class="product--image image lazyload"
               src="{{ image | img_url: "small" }}"
               data-src="{{ img_url }}"
               data-widths="[180, 370, 590, 740, 900, 1080, 1296, 1512, 1728, 2048]"
               data-aspectratio="{{ image.aspect_ratio }}"
               data-sizes="auto"
               alt="{{ image.alt | escape }}"
               data-image>
        </div>
      </div>
    </a>
  {% endunless %}

</div>
{% endif %}


{% if type == "form" %}
<div class="form-item-upsell_bundles {% if item == "first" %}current-form-upsell_bundles{% endif %}">

  <label for="upsellBundleCheckbox-{{ product.id }}" class="label-upsell_bundles">
    <input id="upsellBundleCheckbox-{{ product.id }}" class="checkbox-upsell_bundles" data-product-id="{{ product.id }} " type="checkbox" value="{{ product.id }}" checked>
    {% if item == "first" %}
    <strong>{{ section.settings.dbtfy_upsell_bundles_current }}</strong>
    {% endif %}
    <span class="title-upsell_bundles">{{ product.title }}</span>
    {% if section.settings.dbtfy_upsell_bundles_reviews %}
      {% include "review-badge", badge_template: "grid" %}
    {% endif %}
  </label>

  <form data-id="{{product.id}}" id="upsellBundles-{{product.id}}" autocomplete="off" action="/cart/add" method="post" class="form-upsell_bundles active-upsell_bundles" enctype="multipart/form-data">
    <select class="select--small select-upsell_bundles" name="id">
      {% unless product.has_only_default_variant %}
        {% for variant in product.variants %}
          {% if variant.available %}
            <option {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %} value="{{ variant.id }}" data-price="{{ variant.price }}">
              {{ variant.title | escape }} - {{ variant.price | money }}
            </option>
          {% endif %}
        {% endfor %}
      {% else %}
      <option {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %} value="{{ variant.id }}" data-price="{{ variant.price }}">
        {{ product.title | escape }} - {{ variant.price | money }}
      </option>
      {% endunless %}
    </select>
  </form>

</div>
{% endif %}

{% endunless %}